# 系统架构图

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        彩票系统架构                              │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┐      ┌─────────────────┐      ┌──────────────┐
│   定时任务       │      │   手动触发      │      │  Web访问     │
│   (Cron Job)    │      │   (CLI)         │      │  (Browser)   │
└────────┬────────┘      └────────┬────────┘      └──────┬───────┘
         │                        │                       │
         └────────────────────────┼───────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  ApiController.class.php│
                    │  (主采集控制器)          │
                    └────────────┬────────────┘
                                 │
                    ┌────────────┴────────────┐
                    │                          │
                    ▼                          ▼
          ┌──────────────────┐      ┌──────────────────┐
          │  外部API (已失效) │      │  LocalApiController│
          │  ❌ 不可用        │      │  ✅ 本地API        │
          └─────────┬────────┘      └─────────┬─────────┘
                    │                          │
                    │ (失败重试3次)            │ (读取数据库)
                    │                          │
                    └──────────┬───────────────┘
                               │
                               ▼
                    ┌──────────────────┐
                    │  智能降级机制    │
                    │  自动切换到本地  │
                    └─────────┬────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │           数据库系统 (MySQL)             │
        ├─────────────────────────────────────────┤
        │  think_time       期数时间表             │
        │  think_caiji_admin 预设开奖表(可选)      │
        │  think_caiji      开奖结果表             │
        └─────────────────────────────────────────┘
```

## 数据流程图

```
开始
  │
  ▼
┌──────────────────┐
│ 1. 读取配置       │  ← site.php (use_local_api=1)
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 2. 查询当前期数   │  ← think_time 表
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 3. 检查预设数据   │  ← think_caiji_admin 表
└────────┬─────────┘
         │
         ▼
    ┌───┴───┐
    │ 有预设? │
    └───┬───┘
        │
    ┌───┴───┐
    │  是   │              │  否   │
    ▼       └──────────────▼
┌─────────┐          ┌─────────┐
│使用预设 │          │生成随机 │
│号码     │          │号码     │
└────┬────┘          └────┬────┘
     │                    │
     └──────────┬─────────┘
                ▼
     ┌──────────────────┐
     │ 4. 计算下期信息   │
     └────────┬─────────┘
              │
              ▼
     ┌──────────────────┐
     │ 5. 保存到数据库   │  → think_caiji 表
     └────────┬─────────┘
              │
              ▼
     ┌──────────────────┐
     │ 6. 记录日志       │  → Runtime/Logs/
     └────────┬─────────┘
              │
              ▼
            结束
```

## API降级流程

```
请求开始
    │
    ▼
┌──────────────┐
│ 尝试外部API  │
└──────┬───────┘
       │
       ▼
   ┌───────┐
   │ 成功?  │
   └───┬───┘
       │
   ┌───┴───┐
   │  是   │                      │  否   │
   ▼       └──────────────────────▼
返回数据                  ┌──────────────┐
                          │ 重试计数 < 3? │
                          └──────┬───────┘
                                 │
                            ┌────┴────┐
                            │   是     │        │   否   │
                            ▼          └────────▼
                      ┌──────────┐        ┌──────────────┐
                      │ 等待1秒   │        │ 切换本地API  │
                      │ 再次重试  │        └──────┬───────┘
                      └──────────┘               │
                                                 ▼
                                        ┌──────────────┐
                                        │ 读取think_time│
                                        └──────┬───────┘
                                               │
                                               ▼
                                        ┌──────────────┐
                                        │ 生成本地数据 │
                                        └──────┬───────┘
                                               │
                                               ▼
                                            返回数据
```

## 文件依赖关系

```
index.php (入口)
    │
    ├─→ ThinkPHP/ThinkPHP.php (框架核心)
    │
    ├─→ Application/Common/Conf/
    │   ├─→ config.php (基础配置)
    │   ├─→ db.php (数据库配置)
    │   └─→ site.php (站点配置)
    │
    └─→ Application/Home/Controller/
        ├─→ ApiController.class.php (主采集)
        │   ├─→ fetchApiData() (API获取)
        │   └─→ getLocalGameData() (本地生成)
        │
        ├─→ LocalApiController.class.php (本地API)
        │   ├─→ getBj28Data() (北京28)
        │   └─→ getJnd28Data() (加拿大28)
        │
        └─→ CaiController.class.php (其他采集)

辅助工具:
    ├─→ init_time_data.php (初始化)
    ├─→ test_api.php (测试)
    └─→ install_cron.sh (定时任务)

文档:
    ├─→ README.md (英文)
    ├─→ API_FIX_README.md (技术)
    ├─→ 快速修复指南.md (中文)
    └─→ 修复总结.md (总结)
```

## 错误处理流程

```
API调用
    │
    ▼
┌─────────────┐
│ try { ... } │
└──────┬──────┘
       │
       ▼
   ┌───────┐
   │ 异常? │
   └───┬───┘
       │
   ┌───┴───┐
   │  否   │                    │  是   │
   ▼       └────────────────────▼
成功返回              ┌──────────────────┐
                      │ catch (Exception) │
                      └────────┬─────────┘
                               │
                               ▼
                      ┌──────────────────┐
                      │ Log::write()     │
                      │ 记录错误日志     │
                      └────────┬─────────┘
                               │
                               ▼
                      ┌──────────────────┐
                      │ 返回失败标志     │
                      └────────┬─────────┘
                               │
                               ▼
                      ┌──────────────────┐
                      │ 触发降级机制     │
                      └──────────────────┘
```

## 部署流程图

```
开始部署
    │
    ▼
┌──────────────────┐
│ 1. 下载代码       │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 2. 配置数据库     │  编辑 db.php
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 3. 导入SQL        │  mysql < think_admin.sql
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 4. 初始化数据     │  php init_time_data.php
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 5. 测试系统       │  php test_api.php
└────────┬─────────┘
         │
         ▼
    ┌────────┐
    │ 通过?   │
    └────┬───┘
         │
     ┌───┴───┐
     │  是   │              │  否   │
     ▼       └──────────────▼
┌─────────┐           ┌──────────┐
│安装定时 │           │ 查看日志 │
│任务     │           │ 排查问题 │
└────┬────┘           └──────────┘
     │
     ▼
┌─────────┐
│ 完成!   │
└─────────┘
```

## 数据库表关系

```
┌─────────────────────────────────────────────┐
│              think_time                     │
│  存储: 每期的时间安排                        │
├─────────────────────────────────────────────┤
│  id          主键                           │
│  game        游戏类型 (bj28, jnd28)         │
│  actionno    期号 (1-288, 1-480)            │
│  actiontime  时间 (HH:mm:ss)                │
└──────────────────┬──────────────────────────┘
                   │
                   │ (关联: 查询当前期号)
                   │
┌──────────────────▼──────────────────────────┐
│          think_caiji_admin                  │
│  存储: 预设的开奖号码(可选)                  │
├─────────────────────────────────────────────┤
│  id           主键                          │
│  game         游戏类型                       │
│  periodnumber 期号 (20241005001)            │
│  awardnumbers 号码 (1,2,3)                  │
│  addtime      日期 (20241005)               │
└──────────────────┬──────────────────────────┘
                   │
                   │ (关联: 查询预设号码)
                   │
┌──────────────────▼──────────────────────────┐
│             think_caiji                     │
│  存储: 最终的开奖结果                        │
├─────────────────────────────────────────────┤
│  id           主键                          │
│  game         游戏类型                       │
│  periodnumber 期号                          │
│  awardnumbers 号码                          │
│  awardtime    开奖时间                       │
│  addtime      添加时间戳                     │
│  next_term    下期期号                       │
│  next_time    下期时间戳                     │
└─────────────────────────────────────────────┘
```

## 系统监控流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Cron执行   │ → │  日志记录   │ → │  错误告警   │
└─────────────┘     └─────────────┘     └─────────────┘
      │                    │                    │
      ▼                    ▼                    ▼
运行采集脚本      写入 Runtime/Logs/    检查错误日志
每5分钟一次       记录操作详情         发送通知(可选)
      │                    │                    │
      └────────────────────┴────────────────────┘
                           │
                           ▼
                   ┌───────────────┐
                   │  数据库持久化 │
                   └───────────────┘
```

---

## 图例说明

- `┌─┐` : 模块/组件
- `│ │` : 连接线
- `→ ▼` : 数据流向
- `✅`  : 可用/正常
- `❌`  : 不可用/失败
- `←`  : 数据来源

---

这些图表清晰展示了系统的各个组成部分及其关系，便于理解和维护。
